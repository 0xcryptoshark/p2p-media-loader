<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <script src="p2p-graph.js"></script>
    <script src="p2p-media-loader-core.js"></script>
    <script src="p2p-media-loader-hlsjs.js"></script>

    <link type="text/css" rel="stylesheet" href="http://code.shutterstock.com/rickshaw/rickshaw.min.css">
    <script src="http://code.shutterstock.com/rickshaw/vendor/d3.min.js"></script>
    <script src="http://code.shutterstock.com/rickshaw/vendor/d3.layout.min.js"></script>
    <script src="http://code.shutterstock.com/rickshaw/rickshaw.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/clappr/latest/clappr.min.js"></script>

    <link rel="stylesheet" href="//releases.flowplayer.org/7.0.4/skin/skin.css">
    <script src="https://releases.flowplayer.org/7.0.4/flowplayer.min.js"></script>
    <script src="https://releases.flowplayer.org/hlsjs/flowplayer.hlsjs.light.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mediaelement/4.2.5/mediaelementplayer.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mediaelement/4.2.5/mediaelement-and-player.min.js"></script>

    <style>
        body {
            margin-top: 1em;
            margin-bottom: 3em;
        }
        #graph {
            max-width: 720px;
            margin: 2em auto;
            border: 1px solid #ccc;
        }
        #video {
            max-width: 720px;
            margin: 2em auto;
        }
        #chart_container {
            position: relative;
            max-width: 720px;
            margin: 2em auto;
        }
        #chart {
            position: relative;
            left: 40px;
        }
        #y_axis {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 40px;
        }
        #y_axis > svg {
            overflow: visible;
        }
        #legend {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1;
        }
    </style>

</head>
<body class="container">

    <form class="form-horizontal" id="videoUrlForm">
        <div class="form-group">
            <label class="control-label col-sm-2" for="url">Video URL:</label>
            <div class="col-sm-6">
                <input type="text" class="form-control" id="url" placeholder="Please enter video url" required
                    value="https://nasa-i.akamaihd.net/hls/live/253565/NASA-NTV1-Public/master.m3u8" />
            </div>
            <div class="col-sm-2">
                <select class="form-control" id="type">
                    <option value="hlsjs" selected>Hls.js</option>
                    <option value="clappr">Clappr</option>
                    <option value="flowplayer">Flowplayer</option>
                    <option value="mediaelement">MediaElement</option>
                </select>
            </div>
            <div class="col-sm-2">
                <button type="submit" class="btn btn-primary">Apply</button>
            </div>
        </div>
    </form>

    <div id="video-container" class="text-center"></div>

    <div id="graph"></div>

    <div id="chart_container">
        <div id="legend"></div>
        <div id="y_axis"></div>
        <div id="chart"></div>
    </div>

<script>

    var DemoApp = (function () {

        var P2PGraphClass = require("p2p-graph");

        function DemoApp() {
            var videoUrlForm = document.getElementById("videoUrlForm");
            videoUrlForm.addEventListener('submit', this.onVideoUrlFormSubmit.bind(this));

            this.videoUrl = videoUrlForm.url.value.trim();
            this.playerType = videoUrlForm.type.value;
            this.videoContainer = document.getElementById("video-container");

            this.graph = new P2PGraphClass("#graph");
            this.graph.add({ id: "me", name: "You", me: true });

            this.downloadSpeedTimespan = 10; // seconds

            this.initChart();
            this.restartDemo();
        }

        DemoApp.prototype.restartDemo = function () {

            this.downloadStats = [];

            while (this.videoContainer.hasChildNodes()) {
                this.videoContainer.removeChild(this.videoContainer.lastChild);
            }

            this.p2pmlLoader = new p2pml.HybridLoader();
            this.p2pmlLoader.on(p2pml.LoaderEvents.ChunkBytesLoaded, this.onBytesLoaded.bind(this));

            this.chunkManager = new p2pml.hlsjs.ChunkManager(this.p2pmlLoader);

            switch (this.playerType) {
                case 'hlsjs':
                    this.initHlsJsPlayer();
                    break;
                case 'clappr':
                    this.initClapprPlayer();
                    break;
                case 'flowplayer':
                    this.initFlowplayerPlayer();
                    break;
                case 'mediaelement':
                    this.initMediaElementPlayer();
                    break;
            }

            this.refreshChart();
            this.refreshGraph();
        };

        DemoApp.prototype.onVideoUrlFormSubmit = function (event) {
            event.preventDefault();
            this.videoUrl = event.currentTarget.url.value.trim();
            this.playerType = event.currentTarget.type.value;
            this.restartDemo();
        };

        DemoApp.prototype.initHlsJsPlayer = function () {
            if (Hls.isSupported()) {
                var video = document.createElement("video");
                video.id = "video";
                video.controls = true;
                this.videoContainer.appendChild(video);

                var hls = new Hls();
                p2pml.hlsjs.initHlsJsPlayer(hls, { "chunkManager": this.chunkManager });
                hls.loadSource(this.videoUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    video.play();
                    video.volume = 0;
                });
            }
        };

        DemoApp.prototype.initClapprPlayer = function () {
            var video = document.createElement("div");
            video.id = "video";
            this.videoContainer.appendChild(video);

            var player = new Clappr.Player({
                parentId: "#video",
                source: this.videoUrl
            });
            p2pml.hlsjs.initClapprPlayer(player, { "chunkManager": this.chunkManager });
            player.setVolume(0);
            player.play();
        };

        DemoApp.prototype.initMediaElementPlayer = function () {

            var video = document.createElement("video");
            video.id = "video";
            this.videoContainer.appendChild(video);

            var player = new MediaElementPlayer("video", {
                stretching: "responsive",
                startVolume: 0,
                hls: {
                    loader: p2pml.hlsjs.createLoaderClass(this.chunkManager)
                },
                success: function (mediaElement) {
                    p2pml.hlsjs.initMediaElementJsPlayer(mediaElement);
                }
            });

            player.setSrc(this.videoUrl);
            player.options.forceLive = true;

            player.load();
            player.play();
        };

        DemoApp.prototype.initFlowplayerPlayer = function () {
            var video = document.createElement("div");
            video.id = "video";
            video.className = "fp-slim";
            this.videoContainer.appendChild(video);

            var player = flowplayer("#video", {
                autoplay: true,
                volume: 0,
                clip: {
                    sources: [{
                        type: "application/x-mpegurl",
                        live: true,
                        src: this.videoUrl
                    }]
                }
            });

            p2pml.hlsjs.initFlowplayerHlsJsPlayer(player, { "chunkManager": this.chunkManager });
        };

        DemoApp.prototype.initChart = function (event) {
            this.chart = new Rickshaw.Graph({
                element: document.querySelector("#chart"),
                width: 680,
                renderer: 'multi',
                interpolation: "basis",
                stack: false,
                series: [
                    {name: "Upload", color: "#ff0000", data: [], renderer: 'line'},
                    {name: "Total", color: "#bde587", data: [], renderer: 'area'},
                    {name: "P2P", color: "#88b9ea", data: [], renderer: 'area'},
                    {name: "Http", color: "#eae288", data: [], renderer: 'area'}

                ]
            });

            new Rickshaw.Graph.Axis.X({
                graph: this.chart,
                tickFormat: function() { return ''}
            });

            new Rickshaw.Graph.Axis.Y({
                graph: this.chart,
                orientation: 'left',
                element: document.getElementById('y_axis')
            });

            this.legend = new Rickshaw.Graph.Legend({
                graph: this.chart,
                element: document.getElementById('legend')
            });

            this.chart.render();
            setInterval(this.updateChartData.bind(this), 100);
        };

        DemoApp.prototype.refreshChart = function () {
            var data0 = this.chart.series[0].data;
            var data1 = this.chart.series[1].data;
            var data2 = this.chart.series[2].data;
            var data3 = this.chart.series[3].data;
            var lastX = data0.length > 0 ? data0[data0.length - 1].x : -1;

            var seriesDataMapper = function(currentValue, index) {
                return {x: index + lastX + 1, y: 0};
            };

            data0.length = 0;
            data1.length = 0;
            data2.length = 0;
            data3.length = 0;

            var stubData = Array.apply(null, Array(200)).map(seriesDataMapper);
            data0.push.apply(data0, stubData.slice(0));
            data1.push.apply(data1, stubData.slice(0));
            data2.push.apply(data2, stubData.slice(0));
            data3.push.apply(data3, stubData.slice(0));

            this.chart.update();
        };

        DemoApp.prototype.updateChartData = function () {
            if (this.chart) {
                var speed = this.getDownloadSpeed();
                var http = Number((speed.http * 8 / 1000000).toFixed(2));
                var p2p = Number((speed.p2p * 8 / 1000000).toFixed(2));
                var total = http + p2p;
                var upload = 0;

                var data0 = this.chart.series[0].data;
                var data1 = this.chart.series[1].data;
                var data2 = this.chart.series[2].data;
                var data3 = this.chart.series[3].data;
                var lastX = data0.length > 0 ? data0[data0.length - 1].x : -1;

                data0.shift();
                data1.shift();
                data2.shift();
                data3.shift();
                data0.push({x: lastX + 1, y: upload});
                data1.push({x: lastX + 1, y: total + 0.1});
                data2.push({x: lastX + 1, y: total});
                data3.push({x: lastX + 1, y: http});
                this.chart.update();

                this.formatChartLegendline(0, http);
                this.formatChartLegendline(1, p2p);
                this.formatChartLegendline(2, total);
                this.formatChartLegendline(3, 0);
            }
        };

        DemoApp.prototype.formatChartLegendline = function (index, speed) {
            if (this.legend) {
                var line = this.legend.lines[index];
                line.element.childNodes[1].textContent = line.series.name + ' - '+ speed + ' Mbps';
            }
        };

        DemoApp.prototype.getDownloadSpeed = function () {
            var startingPoint = Date.now() - (this.downloadSpeedTimespan * 1000);
            var httpSize = 0;
            var p2pSize = 0;

            var i = this.downloadStats.length;
            while (i--) {
                var stat = this.downloadStats[i];
                if (stat.timestamp < startingPoint) {
                	break;
                }

                if (stat.method === "p2p") {
                    p2pSize += stat.size;
                } else if (stat.method === "http") {
                    httpSize += stat.size;
                }
            }

            this.downloadStats.splice(0, i + 1);

            return {p2p: p2pSize / this.downloadSpeedTimespan, http: httpSize / this.downloadSpeedTimespan};
        };

        DemoApp.prototype.onBytesLoaded = function (data) {
            this.downloadStats.push(data);
        };

        DemoApp.prototype.refreshGraph = function (p2pLoader) {
            var nodes = this.graph.list();
            for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].id !== "me") {
                    this.graph.disconnect("me", nodes[i].id);
                    this.graph.remove(nodes[i].id);
                }
            }

            this.p2pmlLoader.on(p2pml.LoaderEvents.PeerConnect, this.onPeerConnect.bind(this));
            this.p2pmlLoader.on(p2pml.LoaderEvents.PeerClose, this.onPeerClose.bind(this));
        };

        DemoApp.prototype.onPeerConnect = function (mediaPeer) {
            var peer = mediaPeer.peer;
            if (!this.graph.hasPeer([peer.id])) {
                this.graph.add({id: peer.id, name: peer.remoteAddress || 'Unknown'});
                this.graph.connect("me", peer.id);
            }
        };

        DemoApp.prototype.onPeerClose = function (mediaPeer) {
            var peer = mediaPeer.peer;
            if (this.graph.hasPeer([peer.id])) {
                this.graph.disconnect("me", peer.id);
                this.graph.remove(peer.id);
            }
        };

        return DemoApp;
    }());

    new DemoApp();

</script>

</body>
</html>
