<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <script src="p2p-graph.js"></script>
    <script src="p2p-media-loader-core.js"></script>
    <script src="p2p-media-loader-hlsjs.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/clappr/latest/clappr.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>

    <style>
        body {
            margin-top: 1em;
            margin-bottom: 3em;
        }
        #graph {
            max-width: 720px;
            margin: 2em auto;
            border: 1px solid #ccc;
        }
        #video {
            max-width: 720px;
            margin: 2em auto;
        }
        #chart {
            max-width: 720px;
            margin: 2em auto;
        }
    </style>

</head>
<body class="container">

    <form class="form-horizontal" id="videoUrlForm">
        <div class="form-group">
            <label class="control-label col-sm-2" for="url">Video URL:</label>
            <div class="col-sm-6">
                <input type="text" class="form-control" id="url" placeholder="Please enter video url" required
                    value="http://zoomweblive-lh.akamaihd.net/i/Zoom-TIL-WAP/Zoomweb_1@348071/index_600_av-p.m3u8" />
            </div>
            <div class="col-sm-2">
                <select class="form-control" id="type">
                    <option value="hlsjs" selected>Hls.js</option>
                    <option value="clappr">Clappr</option>
                </select>
            </div>
            <div class="col-sm-2">
                <button type="submit" class="btn btn-primary">Apply</button>
            </div>
        </div>
    </form>

    <div id="video-container" class="text-center"></div>

    <div id="graph"></div>

    <div id="chart"></div>

<script>

    var DemoApp = (function () {

        var P2PGraphClass = require("p2p-graph");

        function DemoApp() {
            var videoUrlForm = document.getElementById("videoUrlForm");
            videoUrlForm.addEventListener('submit', this.onVideoUrlFormSubmit.bind(this));

            this.videoUrl = videoUrlForm.url.value.trim();
            this.playerType = videoUrlForm.type.value;
            this.videoContainer = document.getElementById("video-container");

            this.graph = new P2PGraphClass("#graph");
            this.graph.add({ id: "me", name: "You", me: true });

            this.downloadStats = [];

            setInterval(this.updateChartData.bind(this), 1000);

            this.initDemo();
        }

        DemoApp.prototype.onVideoUrlFormSubmit = function (event) {
            event.preventDefault();
            this.videoUrl = event.currentTarget.url.value.trim();
            this.playerType = event.currentTarget.type.value;
            this.initDemo();
        };

        DemoApp.prototype.initDemo = function () {

            while (this.videoContainer.hasChildNodes()) {
                this.videoContainer.removeChild(this.videoContainer.lastChild);
            }

            this.p2pmlLoader = new p2pml.HybridLoader();
            this.chunkManager = new p2pml.hlsjs.ChunkManager(this.p2pmlLoader);

            switch (this.playerType) {
                case 'hlsjs':
                    this.initHlsJsPlayer();
                    break;
                case 'clappr':
                    this.initClapprPlayer();
                    break;
            }

            this.initChart();
            this.initGraph();
        };

        DemoApp.prototype.initHlsJsPlayer = function () {
            if (Hls.isSupported()) {
                var video = document.createElement("video");
                video.id = "video";
                video.controls = true;
                this.videoContainer.appendChild(video);

                var hls = new Hls();
                p2pml.hlsjs.initHlsJsPlayer(hls, { "chunkManager": this.chunkManager });
                hls.loadSource(this.videoUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    video.play();
                    video.volume = 0;
                });
            }
        };

        DemoApp.prototype.initClapprPlayer = function () {
            var video = document.createElement("div");
            video.id = "video";
            this.videoContainer.appendChild(video);

            var player = new Clappr.Player({
                parentId: "#video",
                source: this.videoUrl
            });
            p2pml.hlsjs.initClapprPlayer(player, { "chunkManager": this.chunkManager });
            player.setVolume(0);
            player.play();
        };

        DemoApp.prototype.initChart = function () {
            var self = this;
            this.p2pmlLoader.on("statistics_file_loaded", this.onFileLoaded.bind(this));

            var stubData = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];

            if (this.chart) {
                this.chart.destroy();
            }

            this.chart = Highcharts.chart("chart", {
                chart: {
                    type: "areaspline"
                },
                legend: {
                    layout: 'vertical',
                    align: 'left',
                    verticalAlign: 'top',
                    x: 60,
                    y: 40,
                    floating: true,
                    borderWidth: 1,
                    backgroundColor: '#FFFFFF',
                    labelFormatter: function() {
                        return this.name + ' - ' + this.yData[this.yData.length - 1] + 'Kbps';
                    }
                },
                title: {
                    text: 'Network'
                },
                tooltip: {
                    enabled: false
                },
                xAxis: {
                    title: {
                        text: 'Time',
                        margin: 20

                    },
                    labels: {
                        formatter: function () {
                            /*if (this.value >= 60) {
                                return this.value - 60;
                            }*/
                            return '';
                        }
                    },
                    tickmarkPlacement: false,
                    categories: stubData
                },
                yAxis: {
                    title: {
                        text: 'Speed (Kbps)'
                    },
                    max: 100
                },
                plotOptions: {
                    areaspline: {
                        stacking: 'normal',
                        marker: {
                            enabled: false,
                            states: {
                                hover: {
                                    enabled: false
                                }
                            }
                        }
                    }
                },
                series: [{
                    name: 'P2P Speed',
                    data: stubData,
                    color: '#BDE587',
                    fillOpacity: 1
                }, {
                    name: 'HTTP Speed',
                    data: stubData,
                    color: '#C0C0C0',
                    fillOpacity: 1
                }],
                credits: {
                    enabled: false
                }
            });
        };

        DemoApp.prototype.updateChartData = function () {
            if (this.chart) {
                var downloadSpeed = this.getDownloadSpeed();
                var chart = this.chart;
                var legend = this.chart.legend;
                var series1 = this.chart.series[0];
                var series2 = this.chart.series[1];
                var yAxis = this.chart.yAxis[0];

                var p2p = Math.round(downloadSpeed[0] / 1024, 2);
                var http = Math.round(downloadSpeed[1] / 1024, 2);

                if (p2p + http > yAxis.max) {
                    yAxis.update({max: yAxis.max + 100});
                }

                series1.addPoint(p2p, false, true, false);
                series2.addPoint(http, false, true, false);

                chart.redraw(true);
                legend.update();
            }
        };

        DemoApp.prototype.initGraph = function (p2pLoader) {
            var nodes = this.graph.list();
            for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].id !== "me") {
                    this.graph.disconnect("me", nodes[i].id);
                    this.graph.remove(nodes[i].id);
                }
            }

            this.p2pmlLoader.on("peer_connect", this.onPeerConnect.bind(this));
            this.p2pmlLoader.on("peer_close", this.onPeerClose.bind(this));
        };

        DemoApp.prototype.getDownloadSpeed = function () {
            var startingPoint = Date.now() - 10000;
            var httpSize = 0;
            var p2pSize = 0;

            for (var i = this.downloadStats.length - 1; i >= 0; i--) {
                var stat = this.downloadStats[i];
                if (stat.timestamp >= startingPoint) {
                    if (stat.method === "p2p") {
                        p2pSize += stat.size;
                    } else if (stat.method === "http") {
                        httpSize += stat.size;
                    }
                }
            }

            return [p2pSize / 10, httpSize / 10];
        };

        DemoApp.prototype.onFileLoaded = function (data) {
            this.downloadStats.push(data);
        };

        DemoApp.prototype.onPeerConnect = function (mediaPeer) {
            var peer = mediaPeer.peer;
            this.graph.add({ id: peer.id, name: peer.remoteAddress || 'Unknown' });
            this.graph.connect("me", peer.id);
        };

        DemoApp.prototype.onPeerClose = function (mediaPeer) {
            var peer = mediaPeer.peer;
            this.graph.disconnect("me", peer.id);
            this.graph.remove(peer.id);
        };

        return DemoApp;
    }());

    new DemoApp();

</script>

</body>
</html>
