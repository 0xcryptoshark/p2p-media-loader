<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <script src="p2p-graph.js"></script>
    <script src="p2p-media-loader-core.js"></script>
    <script src="p2p-media-loader-hlsjs.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        #videoUrlForm {
            margin-top: 1em;
        }
        #video {
            max-width: 720px;
        }
    </style>

</head>
<body class="container">

    <form class="form-horizontal" id="videoUrlForm">
        <div class="form-group">
            <label class="control-label col-sm-2" for="url">Video URL:</label>
            <div class="col-sm-8">
                <input type="text" class="form-control" id="url" placeholder="Please enter video url" required
                    value="http://zoomweblive-lh.akamaihd.net/i/Zoom-TIL-WAP/Zoomweb_1@348071/index_600_av-p.m3u8" />
            </div>
            <div class="col-sm-2">
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </div>
    </form>

    <video id="video" class="center-block" controls></video>

    <div id="graph-container"></div>

<script>

    var P2PGraph = (function () {
        var P2PGraphClass = require("p2p-graph");

        function P2PGraph(containerId, p2pLoader) {
            var graphElement =  document.createElement("div");
            graphElement.id = "graph";

            this.container = document.getElementById(containerId);
            this.container.appendChild(graphElement);

            this.graph = new P2PGraphClass("#graph");
            this.graph.add({id: "me", name: "You", me: true});

            p2pLoader.on("peer_connect", this.onPeerConnect.bind(this));
            p2pLoader.on("peer_close", this.onPeerClose.bind(this));
        }
        P2PGraph.prototype.onPeerConnect = function (mediaPeer) {
            var peer = mediaPeer.peer;
            this.graph.add({ id: peer.id, name: peer.remoteAddress || 'Unknown' });
            this.graph.connect("me", peer.id);
        };
        P2PGraph.prototype.onPeerClose = function (mediaPeer) {
            var peer = mediaPeer.peer;
            this.graph.disconnect("me", peer.id);
            this.graph.remove(peer.id);
        };
        P2PGraph.prototype.destroy = function () {
            this.graph.destroy();
            while (this.container.hasChildNodes()) {
                this.container.removeChild(this.container.lastChild);
            }
        };
        return P2PGraph;
    }());

    var videoUrlForm = document.getElementById("videoUrlForm");
    videoUrlForm.addEventListener('submit', function(event){
        event.preventDefault();
        initDemo(videoUrlForm.url.value.trim());
    });

    var graph;
    function initDemo(videoUrl) {
        if (Hls.isSupported()) {
            var hls = new Hls();

            var p2pmlLoader = new p2pml.HybridLoader();
            var chunkManager = new p2pml.hlsjs.ChunkManager(p2pmlLoader);
            p2pml.hlsjs.initHlsJsPlayer(hls, {"chunkManager" : chunkManager});

            hls.loadSource(videoUrl);

            var video = document.getElementById("video");
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                video.play();
                video.volume = 0.01;
            });

            if (graph) {
                graph.destroy();
            }
            graph = new P2PGraph("graph-container", p2pmlLoader);
        }
    }

    initDemo(videoUrlForm.url.value.trim());

</script>

</body>
</html>
