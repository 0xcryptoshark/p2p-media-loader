<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <script src="p2p-graph.js"></script>
    <script src="p2p-media-loader-core.js"></script>
    <script src="p2p-media-loader-hlsjs.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        #video {
            width: 720px;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
    </style>

</head>
<body >

<video id="video" controls></video>
<div id="graph" controls></div>

<script>

    var P2PGraphClass = require("p2p-graph");
    var P2PGraph = (function () {
        function P2PGraph(selector, p2pLoader) {
            this.graph = new P2PGraphClass(selector);
            this.graph.add({id: "me", name: "You", me: true});

            p2pLoader.on("peer_connect", this.onPeerConnect.bind(this));
            p2pLoader.on("peer_close", this.onPeerClose.bind(this));
        }
        P2PGraph.prototype.onPeerConnect = function (mediaPeer) {
            var peer = mediaPeer.peer;
            this.graph.add({ id: peer.id, name: peer.remoteAddress || 'Unknown' });
            this.graph.connect("me", peer.id);
        };
        P2PGraph.prototype.onPeerClose = function (mediaPeer) {
            var peer = mediaPeer.peer;
            this.graph.disconnect("me", peer.id);
            this.graph.remove(peer.id);
        };
        return P2PGraph;
    }());

    if (Hls.isSupported()) {

        var hls = new Hls();

        var p2pmlLoader = new p2pml.HybridLoader();
        var chunkManager = new p2pml.hlsjs.ChunkManager(p2pmlLoader);
        p2pml.hlsjs.initPlayer(hls, {"chunkManager" : chunkManager});

        new P2PGraph("#graph", p2pmlLoader);

        //hls.loadSource("https://wowza.peer5.com/live/smil:ski.smil/playlist.m3u8"); // live, 20 chunks ~5sec each
        //hls.loadSource("http://wms.shared.streamshow.it/carinatv/carinatv/playlist.m3u8"); // live, 3 chunks ~10 sec each
        //hls.loadSource("https://video-dev.github.io/streams/x36xhzz/x36xhzz.m3u8"); // VOD, 64 chunks
        //hls.loadSource("https://wowza-cdn.streamroot.io/vodOriginSite/tears_of_steel720p.mp4/playlist.m3u8");
        //hls.loadSource("http://cdn3.viblast.com/streams/hls/airshow/playlist.m3u8");
        hls.loadSource("http://zoomweblive-lh.akamaihd.net/i/Zoom-TIL-WAP/Zoomweb_1@348071/index_600_av-p.m3u8"); // stream, 178 chunks ~10 sec each
        //hls.nextLevel = 0;

        var video = document.getElementById("video");
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
            video.play();
            video.volume = 0.01;
        });
    }

</script>

</body>
</html>
